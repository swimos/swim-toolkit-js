<!DOCTYPE html>
<html>
  <head>
    <title>Swim GeoGrid</title>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0, shrink-to-fit=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css">
  </head>
  <body swim-theme style="width: 100vw; height: 100vh; margin: 0;">
    <script src="../../node_modules/tslib/tslib.js"></script>
    <script src="../../swim-runtime/swim-core/dist/swim-core.js"></script>
    <script src="../../swim-runtime/swim-host/dist/swim-host.js"></script>
    <script src="../swim-ui/dist/swim-ui.js"></script>
    <script src="../swim-maps/dist/swim-maps.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script>

mapboxgl.accessToken = "pk.eyJ1Ijoic3dpbWl0IiwiYSI6ImNqY2c3NXZkYzFoa2QycXQ1eXl1Mnd6M3EifQ.qpRE7xC08AyZfxJ56LoN7w";

const bodyView = swim.HtmlView.fromNode(document.body);

const ExampleMapboxController = (function () {
  const extraInitializers = [];
  const mapInitializers = [];
  const canvasInitializers = [];
  const layersInitializers = [];
  class ExampleMapboxController extends swim.MapController {
    constructor() {
      super();
      __runInitializers(this, extraInitializers);
      this.map = __runInitializers(this, mapInitializers, this.map);
      this.canvas = __runInitializers(this, canvasInitializers, this.canvas);
      this.layers = __runInitializers(this, layersInitializers, this.layers);
    }
    createMapView(containerView) {
      const map = new mapboxgl.Map({
        container: containerView.node,
        //style: "mapbox://styles/mapbox/dark-v10",
        center: {lng: 0, lat: 0},
        zoom: 1,
      });
      return new swim.MapboxView(map);
    }
  }
  __esDecorate(null, null, [swim.TraitViewRef({
    extends: true,
    initView(mapView) {
      super.initView(mapView);
      mapView.modifyMood(swim.Feel.default, [[swim.Feel.primary, 1]]);
    },
  })], {kind: "field", name: "map", static: false, private: false, access: {has: obj => "map" in obj, get: obj => obj.map, set: (obj, value) => { obj.map = value; }}}, mapInitializers, extraInitializers);
  __esDecorate(null, null, [swim.ViewRef({
    extends: true,
    initView(canvasView) {
      super.initView(canvasView);
      canvasView.pointerEventsEnabled(true).touchAction("manipulation");
    },
  })], {kind: "field", name: "canvas", static: false, private: false, access: {has: obj => "canvas" in obj, get: obj => obj.canvas, set: (obj, value) => { obj.canvas = value; }}}, canvasInitializers, extraInitializers);
  __esDecorate(null, null, [swim.TraitViewControllerSet({
    extends: true,
    createController(layerTrait) {
      if (layerTrait instanceof ExampleTileTrait) {
        return new ExampleTileController(swim.GeoTile.root());
      } else {
        return super.createController(layerTrait);
      }
    },
  })], {kind: "field", name: "layers", static: false, private: false, access: {has: obj => "layers" in obj, get: obj => obj.layers, set: (obj, value) => { obj.layers = value; }}}, layersInitializers, extraInitializers);
  return ExampleMapboxController;
})();

const ExampleTileController = (function () {
  const extraInitializers = [];
  const geoInitializers = [];
  const tilesInitializers = [];
  class ExampleTileController extends swim.GeoTileController {
    constructor(geoTile) {
      super(geoTile);
      __runInitializers(this, extraInitializers);
      this.geo = __runInitializers(this, geoInitializers, this.geo);
      this.tiles = __runInitializers(this, tilesInitializers, this.tiles);
    }
  }
  __esDecorate(null, null, [swim.TraitViewRef({
    extends: true,
    initView(tileView) {
      super.initView(tileView);
      tileView.geoBoundsColor("#008f11");
    },
  })], {kind: "field", name: "geo", static: false, private: false, access: {has: obj => "geo" in obj, get: obj => obj.geo, set: (obj, value) => { obj.geo = value; }}}, geoInitializers, extraInitializers);
  __esDecorate(null, null, [swim.TraitViewControllerSet({
    extends: true,
    attachTileView(tileView, tileController) {
      super.attachTileView(tileView, tileController);
    },
    createController(tileTrait) {
      return tileTrait !== void 0 ? new ExampleTileController(tileTrait.geoTile) : null;
    },
  })], {kind: "field", name: "tiles", static: false, private: false, access: {has: obj => "tiles" in obj, get: obj => obj.tiles, set: (obj, value) => { obj.tiles = value; }}}, tilesInitializers, extraInitializers);
  return ExampleTileController;
})();

const ExampleTileTrait = (function () {
  const extraInitializers = [];
  const vehiclesDownlinkInitializers = [];
  class ExampleTileTrait extends swim.GeoTileTrait {
    constructor(geoTile) {
      super(geoTile);
      __runInitializers(this, extraInitializers);
      this.vehiclesDownlinkInitializers = __runInitializers(this, vehiclesDownlinkInitializers, this.vehiclesDownlinkInitializers);
      const tileId = geoTile.x + "," + geoTile.y + "," + geoTile.z;
      this.nodeUri.setValue(swim.Uri.path(swim.UriPath.of("/", "map", "/", tileId)));
    }
    createTileTrait(geoTile) {
      return new ExampleTileTrait(geoTile);
    }
    onStartConsuming() {
      super.onStartConsuming();
      console.log("onStartConsuming " + this.geoTile);
    }
    onStopConsuming() {
      super.onStopConsuming();
      console.log("onStopConsuming " + this.geoTile);
    }
  }
  __esDecorate(null, null, [swim.MapDownlink({
    lazy: false,
    consumed: true,
    laneUri: "vehicles",
    didUpdate(key, value) {
      console.log(this.nodeUri + " updateVehicle " + key.toAny() + ":", value.toAny());
    },
  })], {kind: "field", name: "vehiclesDownlink", static: false, private: false, access: {has: obj => "vehiclesDownlink" in obj, get: obj => obj.vehiclesDownlink, set: (obj, value) => { obj.vehiclesDownlink = value; }}}, vehiclesDownlinkInitializers, extraInitializers);
  return ExampleTileTrait;
})();

const layerModel = new swim.Model();
const layerTrait = new ExampleTileTrait(swim.GeoTile.root());
layerModel.setTrait("layer", layerTrait);

const mapModel = new swim.Model();
mapModel.hostUri.setValue("warps://transit.swim.services");
mapModel.mount();
const mapTrait = new swim.MapTrait();
mapModel.setTrait("map", mapTrait);
mapModel.appendChild(layerModel, "layer");

const mapController = new ExampleMapboxController();
mapController.mount();
mapController.map.setTrait(mapTrait);
mapController.container.setView(bodyView);

    </script>
  </body>
</html>
